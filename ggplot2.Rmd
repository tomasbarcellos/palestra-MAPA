---
title: ggplot2
output:
  html_document: 
    fig_height: 6
    fig_width: 9
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(knitr)
library(tidyr)
options(scipen = 999)
anscombe_tidy <- anscombe %>% gather() %>%
  separate(col = key, c('variavel', 'conjunto'), sep = 1) %>%
  group_by(variavel) %>% mutate(row = 1:n()) %>%
  spread(variavel, value) %>% select(-row)

dados <- readRDS('amostra-PAM.RDS')
dados <- dados %>% filter(cultura %in% c("Arroz (em casca)", "Feijão (em grão)",
                                         "Soja (em grão)", "Milho (em grão)" ))
```

## Exemplo

```{r, echo = FALSE}
ggplot(dados, aes(x = cultura, y = produtividade, fill = cultura)) +
  geom_violin(draw_quantiles = 0.5) + 
  theme_minimal() + 
  labs(title = "Distribuição da produtividade agrícola por cultura", x = "",
       y = "Produtividade (Kg/Ha)", fill = "")
```


<!-- ## Exemplo -->

<!-- ```{r diamonds, echo=FALSE} -->
<!-- ggplot(dados, aes(x = produtividade, y = area_plantada, col = regiao)) + -->
<!--   geom_point(aes(size = VBP)) + -->
<!--   geom_smooth(se = FALSE, method = "lm") + -->
<!--   facet_wrap(~cultura, nrow = 2, scales = "free") -->
<!-- ``` -->

## Para que estudar visualização de dados?

### Quarteto de Anscombe

```{r, echo = FALSE}
kable(anscombe[, c(1,5,2,6,3,7,4,8)])
```

## Para que estudar visualização de dados?

### Quarteto de Anscombe

```{r,  echo = FALSE}
ggplot(anscombe_tidy, aes(x,y)) +
  geom_point() +
  geom_smooth(method = "lm",se = FALSE) +
  facet_wrap(~conjunto, nrow = 2) + theme_bw()
```

## Concepção do ggplot2

O ggplot2 é mais do que um pacote para fazer gráficos; ele é uma tentativa (muito bem sucedida) trazer para o dia-a-dia dos técnicos uma **gramática dos gráficos em camadas**.


#### Por que uma **gramática** dos gráficos?

Através dela podemos definir **sistematicamente** quais são os componentes de um gráficos e como eles se interelacionam.

Veja mais informações em [http://docs.ggplot2.org/](http://docs.ggplot2.org/current/).

## A gramática dos gráficos

![](camadas.png)

## A gramática dos gráficos

|       elemento       |        exemplos         |
|:--------------------:|:-----------------------:|
|  dados (informação)* | produção, fiscalizações |
|   **(a)es**tética*   |      cor, formato       |
|    **geom**etrias*   |      barra, ponto       |
|    e**stat**ísticas  |    mediana, máximo      |
|     **facet**as      |        facetas          |
|   **coord**enadas    |    polar, cartesiana    |
|     **t(h)emas**     |      eixos, título      |

'* aspéctos estéticos impressindíveis para criar um gráfico no ggplot2

## Sintaxe do ggplot2

```{r, eval = FALSE}
ggplot(um_data_frame, aes(estética1 = variável1,
                  estética2 = variável2,
                  estética3 = variável3)) +
  geometria(estética4 = "atributo1") +
  facetas +
  tema
```

Note que cada função cria uma (ou mais) camadas e que usamos o `+` para ir adicionando camadas.

## A camada de dados

A primeira etapa da construção de um gráfico é ter os dados que serão representados graficamente. 

Vamos carregar os dados da Pesquisa Agrícola Municipal (PAM) agregados no nível de grandes regiões para os anos entre 1990 e 2015.

```{r carga}
# importa dados
dados <- readRDS('amostra-PAM.RDS')
```


## Ainda os dados

Ainda precisamos melhorar um pouco a forma como os dados chegaram. O arquivo "amostra-PAM.RDS" traz dados de `r length(unique(dados$cultura))` culturas diferentes e é difícil visualizar tantas variáveis categóricas.

Para faciliar as coisas vamos reduzir nossos dados apenas para as culturas de **arroz**, **feijão**, **milho** e **soja** (grãos) com o código abaixo. 

```{r transforma}
dados <- dados %>% 
  filter(cultura %in% c("Arroz (em casca)", "Feijão (em grão)",
                        "Soja (em grão)", "Milho (em grão)" ))

dados2 <- dados %>% filter(cultura == "Feijão (em grão)")

dados3 <- filter(dados2, regiao == "Centro-Oeste")
```

## Aspectos Estéticos

Os principais aspectos estéticos são:

Estética | Descrição
----------|----------------------------------------
x | Eixo horizontal
y | Eixo vertical
colour | Cor dos pontos ou das linhas das formas
fill | Cor de preencimento 
size | Diametro dos pontos e espessura das linhas
alpha |Transparência
linetype | Tipo (padrão) da linhas
labels | Texto no gráfico ou nos eixos
shape | Forma

## Representando dados

Imagine que você fosse desenhar um gráfico. Como você decidiria até onde deve ir a barra ou onde ficariam os pontos? O computador também precisa de critérios para decidir como representar os dados, como o Valor Bruto da Produção agropecuária (VBP) de uma região, em um gráfico.

Assim, o VBP pode ser representado no eixo vertical ou os faixas de valores podem aparecer como cores ou formato dos dados (até R$ 50 milhões triângulos, entre 50 e 100 quadrados, maiores que 100 circulos).


## Atributos Estéticos

É diferente **mapear** uma estética e **atribuir um valor** a um aspecto estético. Mapear uma variável em uma estética é dizer que a cor **vermelha** representa o Centro-Oeste e a cor **azul** o Sudeste. Isto é diferente de definir a cor de pontos ou barras com a cor **verde**. 

## Atributos Estéticos

### Atribuir cor à elemento estético

```{r}
ggplot(dados2 , aes(x = area_plantada, y = quantidade)) +
  geom_point(col = "red")
```

## Atributos Estéticos

### Mapear a região na cor

```{r}
ggplot(dados2 , aes(x = area_plantada, y = quantidade)) +
  geom_point(aes(col = regiao))
```

## Atributos Estéticos

### Mapear VBP no tamanho

```{r}
ggplot(dados2 , aes(x = area_plantada, y = quantidade)) +
  geom_point(aes(size = VBP), col = "darkgreen", alpha = 0.5)
```

## Aspectos Estéticos - Variáveis contínuas

Estética | Descrição
---------|----------------------------------------
x | Eixo horizontal
y | Eixo vertical
colour | Cor dos pontos ou das linhas das formas
fill | Cor de preencimento 
size | Diametro dos pontos e espessura das linhas
alpha |Transparência

## Atributos Estéticos - Variáveis contínuas

![](decod_continuas.png)

Fonte: www.datacamp.com

## Atributos Estéticos - Variáveis contínuas


```{r}
ggplot(dados3, aes(x = Ano, y = area_plantada, col = produtividade)) +
  geom_point()
```

## Aspectos Estéticos - Variáveis categóricas

Estética | Descrição
----------|----------------------------------------
colour | Cor dos pontos ou das linhas das formas
fill | Cor de preencimento 
size | Diametro dos pontos e espessura das linhas
alpha |Transparência
linetype | Tipo (padrão) da linhas
labels | Texto no gráfico ou nos eixos
shape | Forma

## Atributos Estéticos - Variáveis categóricas

![](decod_categoricas.png)

Fonte: www.datacamp.com

## Aspectos Estéticos - Variáveis categóricas

```{r}
ggplot(dados, aes(x = produtividade, 
                  y = (VBP/area_plantada), col = cultura)) +
  geom_point()
```


## Aspectos Geométricos

Além de ter dados e mapeá-los em atributos estéticos, você deve escolher com que geometrias quer aprensentar seus dados.

As geometrias mais comuns são:

* Pontos (diagrama de dispersão)

* Barras

* Linhas

* Diagrama de baixa (boxplot)

Vamos ver como usar estas geometrias no `ggplot2`.

## geom_point()

Ajudam compreender relação entre variáveis e suas distribuições.

```{r geom_point}
ggplot(dados, aes(x = quantidade, y = area_plantada)) +
  geom_point()
```

## geom_col()

Gráficos de barras são geralmente usados em estatísticas sumarizadas.

```{r geom_bar}
medias <- dados %>% group_by(cultura) %>%
  summarise(area_media = mean(area_plantada))

ggplot(medias, aes(x = cultura, y = area_media)) +
  geom_col()
```

## geom_line() 

Utilizadas para relacionar dados, dar ideia de evolução

```{r geom_line}
# ggplot(dados %>% filter(regiao == "Centro-Oeste"),
#        aes(Ano, area_plantada, col = cultura)) +
#   geom_path(group = 1)
```

## geom_histogram()

```{r geom_histogram, warning=FALSE}
ggplot(dados, 
       aes(x = produtividade)) +
  geom_histogram(binwidth = 800, alpha= 0.8) # definir qtd de intervalos(bins)
```


## Ou então geom_density()

```{r geom_density}
ggplot(dados,
       aes(x = produtividade, fill = cultura)) +
  geom_density(alpha= 0.6)
```


## geom_boxplot()

```{r geom_boxplot}
ggplot(dados,
       aes(x = cultura, y = produtividade)) +
  geom_boxplot(aes(fill = cultura))
```
